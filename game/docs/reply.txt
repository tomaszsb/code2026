ai-bridge-server.js                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ #!/usr/bin/env node                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ /**                                                                                                              â”‚ â”‚
â”‚ â”‚  * AI-to-AI Communication Bridge Server with Human Oversight                                                     â”‚ â”‚
â”‚ â”‚  * Features: Real-time dashboard, approval gates, comment injection                                              â”‚ â”‚
â”‚ â”‚  * Usage: node ai-bridge-server.js                                                                               â”‚ â”‚
â”‚ â”‚  * Dashboard: http://localhost:3001                                                                              â”‚ â”‚
â”‚ â”‚  */                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ const express = require('express');                                                                              â”‚ â”‚
â”‚ â”‚ const http = require('http');                                                                                    â”‚ â”‚
â”‚ â”‚ const socketIo = require('socket.io');                                                                           â”‚ â”‚
â”‚ â”‚ const path = require('path');                                                                                    â”‚ â”‚
â”‚ â”‚ const app = express();                                                                                           â”‚ â”‚
â”‚ â”‚ const server = http.createServer(app);                                                                           â”‚ â”‚
â”‚ â”‚ const io = socketIo(server);                                                                                     â”‚ â”‚
â”‚ â”‚ const PORT = 3001;                                                                                               â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Middleware                                                                                                    â”‚ â”‚
â”‚ â”‚ app.use(express.json({limit: '10mb'}));                                                                          â”‚ â”‚
â”‚ â”‚ app.use(express.urlencoded({extended: true}));                                                                   â”‚ â”‚
â”‚ â”‚ app.use(express.static(path.join(__dirname, 'public')));                                                         â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Communication state                                                                                           â”‚ â”‚
â”‚ â”‚ let conversationHistory = [];                                                                                    â”‚ â”‚
â”‚ â”‚ let pendingApproval = null;                                                                                      â”‚ â”‚
â”‚ â”‚ let pausedCommunication = false;                                                                                 â”‚ â”‚
â”‚ â”‚ let connectedClients = new Set();                                                                                â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Logging with broadcast to dashboard                                                                           â”‚ â”‚
â”‚ â”‚ function logAndBroadcast(message, type = 'system') {                                                             â”‚ â”‚
â”‚ â”‚   const logEntry = {                                                                                             â”‚ â”‚
â”‚ â”‚     timestamp: new Date().toISOString(),                                                                         â”‚ â”‚
â”‚ â”‚     type,                                                                                                        â”‚ â”‚
â”‚ â”‚     message,                                                                                                     â”‚ â”‚
â”‚ â”‚     id: `log_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`                                           â”‚ â”‚
â”‚ â”‚   };                                                                                                             â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   console.log(`[${logEntry.timestamp}] ${type.toUpperCase()}: ${message}`);                                      â”‚ â”‚
â”‚ â”‚   conversationHistory.push(logEntry);                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   // Broadcast to all connected dashboards                                                                       â”‚ â”‚
â”‚ â”‚   io.emit('newMessage', logEntry);                                                                               â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   return logEntry;                                                                                               â”‚ â”‚
â”‚ â”‚ }                                                                                                                â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Dashboard route                                                                                               â”‚ â”‚
â”‚ â”‚ app.get('/', (req, res) => {                                                                                     â”‚ â”‚
â”‚ â”‚   res.sendFile(path.join(__dirname, 'dashboard.html'));                                                          â”‚ â”‚
â”‚ â”‚ });                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Health check                                                                                                  â”‚ â”‚
â”‚ â”‚ app.get('/health', (req, res) => {                                                                               â”‚ â”‚
â”‚ â”‚   res.json({                                                                                                     â”‚ â”‚
â”‚ â”‚     status: 'healthy',                                                                                           â”‚ â”‚
â”‚ â”‚     uptime: process.uptime(),                                                                                    â”‚ â”‚
â”‚ â”‚     paused: pausedCommunication,                                                                                 â”‚ â”‚
â”‚ â”‚     pending_approval: pendingApproval !== null,                                                                  â”‚ â”‚
â”‚ â”‚     connected_clients: connectedClients.size                                                                     â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚ });                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Claude posts tasks (requires approval)                                                                        â”‚ â”‚
â”‚ â”‚ app.post('/task', (req, res) => {                                                                                â”‚ â”‚
â”‚ â”‚   if (pausedCommunication) {                                                                                     â”‚ â”‚
â”‚ â”‚     return res.status(423).json({                                                                                â”‚ â”‚
â”‚ â”‚       status: 'communication_paused',                                                                            â”‚ â”‚
â”‚ â”‚       message: 'Communication is paused. Check dashboard to resume.'                                             â”‚ â”‚
â”‚ â”‚     });                                                                                                          â”‚ â”‚
â”‚ â”‚   }                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   const task = {                                                                                                 â”‚ â”‚
â”‚ â”‚     ...req.body,                                                                                                 â”‚ â”‚
â”‚ â”‚     id: req.body.id || `task_${Date.now()}`,                                                                     â”‚ â”‚
â”‚ â”‚     created_at: new Date().toISOString(),                                                                        â”‚ â”‚
â”‚ â”‚     status: 'pending_approval',                                                                                  â”‚ â”‚
â”‚ â”‚     from: 'claude'                                                                                               â”‚ â”‚
â”‚ â”‚   };                                                                                                             â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   pendingApproval = task;                                                                                        â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   logAndBroadcast(`Claude wants to send task: ${task.description}`, 'claude_request');                           â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   // Notify dashboard of pending approval                                                                        â”‚ â”‚
â”‚ â”‚   io.emit('pendingApproval', {                                                                                   â”‚ â”‚
â”‚ â”‚     task,                                                                                                        â”‚ â”‚
â”‚ â”‚     message: 'New task from Claude requires approval'                                                            â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   res.json({                                                                                                     â”‚ â”‚
â”‚ â”‚     status: 'awaiting_approval',                                                                                 â”‚ â”‚
â”‚ â”‚     task_id: task.id,                                                                                            â”‚ â”‚
â”‚ â”‚     message: 'Task submitted for human approval. Check dashboard.'                                               â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚ });                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Gemini polls for approved tasks                                                                               â”‚ â”‚
â”‚ â”‚ app.get('/task', (req, res) => {                                                                                 â”‚ â”‚
â”‚ â”‚   if (pausedCommunication) {                                                                                     â”‚ â”‚
â”‚ â”‚     return res.json({                                                                                            â”‚ â”‚
â”‚ â”‚       current_task: null,                                                                                        â”‚ â”‚
â”‚ â”‚       has_task: false,                                                                                           â”‚ â”‚
â”‚ â”‚       status: 'communication_paused',                                                                            â”‚ â”‚
â”‚ â”‚       message: 'Communication is paused by human operator'                                                       â”‚ â”‚
â”‚ â”‚     });                                                                                                          â”‚ â”‚
â”‚ â”‚   }                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   // Only return tasks that have been approved                                                                   â”‚ â”‚
â”‚ â”‚   const approvedTask = conversationHistory                                                                       â”‚ â”‚
â”‚ â”‚     .filter(entry => entry.type === 'approved_task')                                                             â”‚ â”‚
â”‚ â”‚     .slice(-1)[0];                                                                                               â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   if (approvedTask) {                                                                                            â”‚ â”‚
â”‚ â”‚     logAndBroadcast(`Gemini retrieved approved task: ${approvedTask.task.id}`, 'gemini_fetch');                  â”‚ â”‚
â”‚ â”‚   }                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   res.json({                                                                                                     â”‚ â”‚
â”‚ â”‚     current_task: approvedTask?.task || null,                                                                    â”‚ â”‚
â”‚ â”‚     has_task: approvedTask !== undefined,                                                                        â”‚ â”‚
â”‚ â”‚     timestamp: new Date().toISOString()                                                                          â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚ });                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Gemini reports completion (requires approval to relay to Claude)                                              â”‚ â”‚
â”‚ â”‚ app.post('/complete', (req, res) => {                                                                            â”‚ â”‚
â”‚ â”‚   const completion = {                                                                                           â”‚ â”‚
â”‚ â”‚     completed_at: new Date().toISOString(),                                                                      â”‚ â”‚
â”‚ â”‚     result: req.body.result || 'completed',                                                                      â”‚ â”‚
â”‚ â”‚     notes: req.body.notes || '',                                                                                 â”‚ â”‚
â”‚ â”‚     files_modified: req.body.files_modified || [],                                                               â”‚ â”‚
â”‚ â”‚     from: 'gemini',                                                                                              â”‚ â”‚
â”‚ â”‚     status: 'pending_approval'                                                                                   â”‚ â”‚
â”‚ â”‚   };                                                                                                             â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   pendingApproval = {                                                                                            â”‚ â”‚
â”‚ â”‚     type: 'completion',                                                                                          â”‚ â”‚
â”‚ â”‚     data: completion                                                                                             â”‚ â”‚
â”‚ â”‚   };                                                                                                             â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   logAndBroadcast(`Gemini completed task: ${completion.result}`, 'gemini_completion');                           â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   io.emit('pendingApproval', {                                                                                   â”‚ â”‚
â”‚ â”‚     completion,                                                                                                  â”‚ â”‚
â”‚ â”‚     message: 'Task completion from Gemini requires approval'                                                     â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   res.json({                                                                                                     â”‚ â”‚
â”‚ â”‚     status: 'completion_submitted',                                                                              â”‚ â”‚
â”‚ â”‚     message: 'Completion submitted for human approval'                                                           â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚ });                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // WebSocket connection for dashboard                                                                            â”‚ â”‚
â”‚ â”‚ io.on('connection', (socket) => {                                                                                â”‚ â”‚
â”‚ â”‚   connectedClients.add(socket.id);                                                                               â”‚ â”‚
â”‚ â”‚   logAndBroadcast(`Dashboard connected (${connectedClients.size} total)`, 'system');                             â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   // Send current state to new connection                                                                        â”‚ â”‚
â”‚ â”‚   socket.emit('conversationHistory', conversationHistory);                                                       â”‚ â”‚
â”‚ â”‚   socket.emit('systemState', {                                                                                   â”‚ â”‚
â”‚ â”‚     paused: pausedCommunication,                                                                                 â”‚ â”‚
â”‚ â”‚     pending_approval: pendingApproval,                                                                           â”‚ â”‚
â”‚ â”‚     connected_clients: connectedClients.size                                                                     â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   // Handle dashboard commands                                                                                   â”‚ â”‚
â”‚ â”‚   socket.on('approveTask', () => {                                                                               â”‚ â”‚
â”‚ â”‚     if (pendingApproval && pendingApproval.from === 'claude') {                                                  â”‚ â”‚
â”‚ â”‚       const approvedEntry = {                                                                                    â”‚ â”‚
â”‚ â”‚         timestamp: new Date().toISOString(),                                                                     â”‚ â”‚
â”‚ â”‚         type: 'approved_task',                                                                                   â”‚ â”‚
â”‚ â”‚         task: pendingApproval,                                                                                   â”‚ â”‚
â”‚ â”‚         message: `Task approved: ${pendingApproval.description}`,                                                â”‚ â”‚
â”‚ â”‚         id: `approved_${Date.now()}`                                                                             â”‚ â”‚
â”‚ â”‚       };                                                                                                         â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚       conversationHistory.push(approvedEntry);                                                                   â”‚ â”‚
â”‚ â”‚       logAndBroadcast(`Human approved task: ${pendingApproval.id}`, 'approval');                                 â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚       pendingApproval = null;                                                                                    â”‚ â”‚
â”‚ â”‚       io.emit('taskApproved', approvedEntry);                                                                    â”‚ â”‚
â”‚ â”‚     }                                                                                                            â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   socket.on('rejectTask', (reason) => {                                                                          â”‚ â”‚
â”‚ â”‚     if (pendingApproval) {                                                                                       â”‚ â”‚
â”‚ â”‚       logAndBroadcast(`Human rejected task: ${reason || 'No reason provided'}`, 'rejection');                    â”‚ â”‚
â”‚ â”‚       pendingApproval = null;                                                                                    â”‚ â”‚
â”‚ â”‚       io.emit('taskRejected', {reason});                                                                         â”‚ â”‚
â”‚ â”‚     }                                                                                                            â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   socket.on('pauseCommunication', () => {                                                                        â”‚ â”‚
â”‚ â”‚     pausedCommunication = true;                                                                                  â”‚ â”‚
â”‚ â”‚     logAndBroadcast('Communication paused by human operator', 'system');                                         â”‚ â”‚
â”‚ â”‚     io.emit('communicationPaused');                                                                              â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   socket.on('resumeCommunication', () => {                                                                       â”‚ â”‚
â”‚ â”‚     pausedCommunication = false;                                                                                 â”‚ â”‚
â”‚ â”‚     logAndBroadcast('Communication resumed by human operator', 'system');                                        â”‚ â”‚
â”‚ â”‚     io.emit('communicationResumed');                                                                             â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   socket.on('addComment', (comment) => {                                                                         â”‚ â”‚
â”‚ â”‚     const commentEntry = {                                                                                       â”‚ â”‚
â”‚ â”‚       timestamp: new Date().toISOString(),                                                                       â”‚ â”‚
â”‚ â”‚       type: 'human_comment',                                                                                     â”‚ â”‚
â”‚ â”‚       message: comment,                                                                                          â”‚ â”‚
â”‚ â”‚       id: `comment_${Date.now()}`                                                                                â”‚ â”‚
â”‚ â”‚     };                                                                                                           â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚     conversationHistory.push(commentEntry);                                                                      â”‚ â”‚
â”‚ â”‚     logAndBroadcast(`Human comment: ${comment}`, 'human');                                                       â”‚ â”‚
â”‚ â”‚     io.emit('newMessage', commentEntry);                                                                         â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚   socket.on('disconnect', () => {                                                                                â”‚ â”‚
â”‚ â”‚     connectedClients.delete(socket.id);                                                                          â”‚ â”‚
â”‚ â”‚     logAndBroadcast(`Dashboard disconnected (${connectedClients.size} remaining)`, 'system');                    â”‚ â”‚
â”‚ â”‚   });                                                                                                            â”‚ â”‚
â”‚ â”‚ });                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Start server                                                                                                  â”‚ â”‚
â”‚ â”‚ server.listen(PORT, () => {                                                                                      â”‚ â”‚
â”‚ â”‚   logAndBroadcast(`AI Communication Bridge Server running on http://localhost:${PORT}`, 'system');               â”‚ â”‚
â”‚ â”‚   logAndBroadcast(`Dashboard available at http://localhost:${PORT}`, 'system');                                  â”‚ â”‚
â”‚ â”‚   console.log('ðŸ¤– Ready for supervised Claude <-> Gemini communication');                                        â”‚ â”‚
â”‚ â”‚ });                                                                                                              â”‚ â”‚
â”‚ â”‚                                                                                                                  â”‚ â”‚
â”‚ â”‚ // Graceful shutdown                                                                                             â”‚ â”‚
â”‚ â”‚ process.on('SIGINT', () => {                                                                                     â”‚ â”‚
â”‚ â”‚   logAndBroadcast('Shutting down AI Bridge Server...', 'system');                                                â”‚ â”‚
â”‚ â”‚   process.exit(0);                                                                                               â”‚ â”‚
â”‚ â”‚ });     